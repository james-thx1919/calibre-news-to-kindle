#!/usr/bin/env python
from calibre.web.feeds.news import BasicNewsRecipe

class GlobeAndMail(BasicNewsRecipe):
    title          = u'The Globe and Mail'
    oldest_article = 2
    max_articles_per_feed = 12  # Dropped from 15 to 12 to save space
    auto_cleanup   = True
    language       = 'en_CA'
    __author__     = 'Kovid Goyal/Modified'

    # --- Cleaning the Clutter (Makes it less clunky) ---
    # This tells Calibre to only grab the actual story content
    keep_only_tags = [
        dict(name='h1'), 
        dict(attrs={'class': ['c-article-body', 'article-body', 'l-article-layout__content']})
    ]
    
    remove_tags = [
        dict(attrs={'class': ['c-article-promo', 'c-share-links', 'c-related-stories', 'o-ads', 'c-article-labels']}),
        dict(name=['aside', 'footer', 'nav'])
    ]

    # --- Navigation & Size Settings ---
    delay = 1
    simultaneous_downloads = 1
    no_stylesheets = True
    no_thumbnails = True
    # If the file is STILL too big after this, we can set this to True:
    no_images = False 

    # --- Login ---
    needs_subscription = True
    requires_password = True
    login_url = 'https://www.theglobeandmail.com/registration/login/'

    def get_browser(self):
        br = BasicNewsRecipe.get_browser(self)
        if self.username and self.password:
            try:
                br.open(self.login_url)
                br.select_form(predicate=lambda f: "email" in [str(c.name) for c in f.controls])
                br['email'] = self.username
                br['password'] = self.password
                br.submit()
            except:
                self.log("Login attempted...")
        return br

    def parse_index(self):
        # I removed 'World' to ensure it fits, you can add it back if needed
        sections = [
            ('Canada', 'https://www.theglobeandmail.com/canada/'),
            ('Politics', 'https://www.theglobeandmail.com/politics/'),
            ('Business', 'https://www.theglobeandmail.com/business/'),
            ('Opinion', 'https://www.theglobeandmail.com/opinion/')
        ]
        ans = []
        for section_title, url in sections:
            articles = []
            soup = self.index_to_soup(url)
            for a in soup.findAll('a', href=True):
                if '/article-' in a['href'] or (a['href'].startswith('/') and len(a['href']) > 30):
                    title = self.tag_to_string(a).strip()
                    if title and len(title) > 15:
                        full_url = 'https://www.theglobeandmail.com' + a['href'] if a['href'].startswith('/') else a['href']
                        articles.append({'title': title, 'url': full_url})
            if articles:
                seen = set()
                final_articles = [art for art in articles if not (art['url'] in seen or seen.add(art['url']))]
                ans.append((section_title, final_articles))
        return ans

    def postprocess_book(self, oeb, opts, log):
        from calibre.utils.img import resize_image
        for item in oeb.manifest:
            if item.media_type.startswith('image/'):
                try:
                    # Aggressive compression to beat Gmail
                    item.data = resize_image(item.data, width=400, height=600, format='JPEG', quality=30)
                except:
                    pass
